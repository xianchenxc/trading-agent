# MVP 多时间框架趋势跟踪策略文档 (v3.0)

## 🧠 MVP 策略核心思想

- 用 **4h 时间框架**判断"市场环境"（趋势过滤），
- 用 **1h 时间框架**判断"入场时机"，
- 用 **RiskManager** 控制"亏多少 & 什么时候必须走"（固定止损 + 追踪止损）。

## ⏱️ 时间周期

- **HTF（Higher Timeframe）**：4 小时（4h）- 用于趋势环境过滤
- **LTF（Lower Timeframe）**：1 小时（1h）- 用于入场执行
- 所有逻辑在 bar close 执行

## 📊 使用指标

策略使用多时间框架指标：

### 4h 时间框架（趋势过滤）

#### 1. EMA（趋势方向）
- EMA50
- EMA200

#### 2. ADX（趋势强度）
- period = 14

**4h 趋势状态判断：**
```
BULL: EMA50 > EMA200 AND ADX > 20
RANGE: 其他情况
```

### 1h 时间框架（入场执行）

#### 1. EMA（趋势方向）
- EMA20
- EMA50

方向判断：
```
EMA20 > EMA50 → 多头趋势
EMA20 < EMA50 → 非多头（MVP 阶段不做空）
```

#### 2. ADX（入场过滤）
- period = 14
- 规则：ADX > 25 → 允许入场

#### 3. Donchian High（突破确认）
- lookback = 20
- 计算最近 20 根已完成 1h K 线的最高价
- **仅使用历史已完成的 K 线，排除当前 bar，避免未来函数**

#### 4. ATR（风控）
- ATR period = 14
- 仅用于日志记录，不参与策略决策

---

## 🎯 入场规则

### 多头 ENTRY（必须全部满足）

1. 当前无持仓（PositionState === FLAT）
2. **4h 趋势状态 === BULL**（EMA50_4h > EMA200_4h AND ADX_4h > 20）
3. ADX_1h > 25
4. EMA20_1h > EMA50_1h
5. **收盘价突破 Donchian High**（close > Donchian High，lookback = 20）

👉 Strategy 只输出信号：

```ts
{
  type: "ENTRY",
  side: "LONG",
  reason: "HTF_BULL_BREAKOUT_CONFIRMED"
}
```

## 🚪 出场规则

### EXIT（v3 重大变化）

**v3 版本：策略层不再生成任何 EXIT 信号**

所有退出都由 **RiskManager** 处理：

1. **初始止损**：固定 1% 止损（entryPrice * 0.99）
2. **追踪止损**：
   - 激活条件：未实现盈亏达到 +1R（初始风险的 1 倍）
   - 激活时：止损移动到盈亏平衡点（entryPrice）
   - 更新规则：基于 EMA20_1H，只能向上移动（保护利润）
   - 触发条件：价格跌破追踪止损或初始止损

**退出原因：**
- `STOP_LOSS_INITIAL`：初始止损触发
- `TRAILING_STOP_HIT`：追踪止损触发

**v3 设计理念：**
- 让利润奔跑：移除策略层的过早退出信号
- 追踪止损跟随趋势：基于 EMA20_1H 动态调整
- 只有止损可以触发退出（初始或追踪）

---

## 🛡️ RiskManager

### 职责

- 仓位大小计算
- 初始止损设置（固定 1%）
- 追踪止损管理
- 强制 EXIT（止损触发）

### 仓位控制

- riskPerTrade = 1%
- 固定止损百分比 = 1%
- 仓位计算：

```ts
stopLoss = entryPrice * (1 - 0.01)  // 固定 1% 止损
riskAmount = equity * 0.01          // 风险金额 = 账户权益 * 1%
positionSize = riskAmount / (entryPrice - stopLoss)
```

### 初始止损（必须）

- stopLoss = entryPrice * 0.99（固定 1%）
- 所有入场都必须设置初始止损

### 追踪止损机制

#### 激活条件
- 未实现盈亏达到 +1R（初始风险的 1 倍）
- 激活时止损移动到盈亏平衡点（entryPrice）

#### 更新规则
- 基于 EMA20_1H 动态更新
- **只能向上移动**，保护已实现利润
- 如果 EMA20_1H 下降，追踪止损保持不变

#### 触发条件
- 价格跌破追踪止损 → `TRAILING_STOP_HIT`
- 价格跌破初始止损 → `STOP_LOSS_INITIAL`

---

## 🔄 架构说明

### 多时间框架设计

- **HTF（4h）**：仅用于入场前的趋势环境过滤
- **LTF（1h）**：负责具体的入场执行逻辑和追踪止损更新

### 策略职责分离

- **Strategy**：只决定何时入场（基于指标信号），**不再生成退出信号**
- **RiskManager**：负责仓位大小、止损计算、追踪止损管理和强制出场
- **Strategy 不访问账户权益**，保持确定性，便于回测

### 安全机制

- 指标缺失时返回 `HOLD`
- HTF 指标缺失时，无法执行入场（需要完整的多时间框架上下文）
- Donchian High 数据不足时，无法执行入场（需要足够的历史数据）
- 追踪止损只能向上移动，保护利润

### 回测安全

- Donchian High 仅基于历史已完成的 K 线计算
- 排除当前 bar，严格避免 lookahead bias
- 所有指标在 bar close 时计算，确保回测与实盘一致
- 追踪止损基于已完成的 EMA20_1H 值，不使用未来数据

---

## 📈 v3 版本变更

### 重大变化

1. **移除策略层退出信号**
   - 删除所有 EXIT 信号（EMA_REVERSAL_1H 等）
   - 策略只生成 ENTRY 信号
   - 所有退出由 RiskManager 处理

2. **固定止损机制**
   - 从基于 ATR 的动态止损改为固定 1% 止损
   - 简化止损计算，提高确定性
   - stopLoss = entryPrice * 0.99

3. **追踪止损机制（新增）**
   - 在 +1R 时激活（移动到盈亏平衡点）
   - 基于 EMA20_1H 动态更新
   - 只能向上移动，保护利润
   - 让利润奔跑，避免过早退出

4. **仓位计算简化**
   - 基于固定百分比止损计算仓位
   - 不再依赖 ATR 动态调整

### 保持不变

- ENTRY 规则（与 v2 完全相同）
- 4h 趋势过滤逻辑
- Donchian High 突破确认
- 指标计算方式
- 多时间框架架构

### v3 设计理念

- **让利润奔跑**：移除策略层的过早退出信号
- **追踪止损跟随趋势**：基于 EMA20_1H 动态调整
- **只有止损可以触发退出**：初始止损或追踪止损
- **简化风控逻辑**：固定百分比止损，提高确定性

---

## 📊 回测结果

## 2025-01-01 ～ 2026-01-01

```
Total Return: $10833.32 (8.33%)
Max Drawdown: $448.95 (4.49%)
Total Trades: 15
Winning Trades: 7
Losing Trades: 8
Win Rate: 46.67%
Profit Factor: 1.95
Average Win: $243.74
Average Loss: $109.11
Max Win: $438.37
```

---

## 🔍 v2 vs v3 对比

| 特性 | v2 | v3 |
|------|----|----|
| **退出信号** | 策略层生成 EXIT 信号（EMA_REVERSAL_1H） | 策略层不生成退出信号 |
| **止损方式** | 基于 ATR 的动态止损（1.5 * ATR） | 固定 1% 止损 |
| **追踪止损** | ❌ 无 | ✅ 有（+1R 激活，基于 EMA20_1H） |
| **利润保护** | 策略层退出信号 | 追踪止损机制 |
| **仓位计算** | 基于 ATR | 基于固定百分比 |
| **入场规则** | ✅ 相同 | ✅ 相同 |

---

## 💡 v3 优势

1. **让利润奔跑**：移除过早退出信号，允许趋势充分发展
2. **动态保护利润**：追踪止损跟随趋势，保护已实现利润
3. **简化逻辑**：固定止损，提高确定性和可预测性
4. **风险可控**：初始止损 + 追踪止损双重保护
5. **趋势跟随**：追踪止损基于 EMA20_1H，更好地跟随趋势
